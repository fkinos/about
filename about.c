#include <SDL2/SDL.h>
#include <stdio.h>
#include <math.h>
#include <time.h>

#define TITLE "ABOUT"
#define WIDTH 220
#define HEIGHT 70

#define BLACK 0x000000
#define WHITE 0xffffff
#define RED 0xff0000

static int zoom = 1;
static int reqdraw;

static SDL_Window *gWindow = NULL;
static SDL_Renderer *gRenderer = NULL;
static SDL_Texture *gTexture = NULL;
static unsigned int *pixels;

unsigned char width[] = {
  6, /*   */ 1, /* ! */ 3, /* " */ 5, /* # */
  5, /* $ */ 5, /* % */ 5, /* & */ 1, /* ' */
  2, /* ( */ 2, /* ) */ 5, /* * */ 5, /* + */
  2, /* , */ 5, /* - */ 1, /* . */ 3, /* / */
  4, /* 0 */ 2, /* 1 */ 4, /* 2 */ 4, /* 3 */
  4, /* 4 */ 4, /* 5 */ 4, /* 6 */ 4, /* 7 */
  4, /* 8 */ 4, /* 9 */ 1, /* : */ 2, /* ; */
  3, /* < */ 5, /* = */ 3, /* > */ 4, /* ? */
  6, /* @ */ 4, /* A */ 4, /* B */ 4, /* C */
  4, /* D */ 3, /* E */ 3, /* F */ 4, /* G */
  4, /* H */ 1, /* I */ 3, /* J */ 4, /* K */
  3, /* L */ 5, /* M */ 4, /* N */ 4, /* O */
  4, /* P */ 4, /* Q */ 4, /* R */ 4, /* S */
  5, /* T */ 4, /* U */ 5, /* V */ 5, /* W */
  5, /* X */ 5, /* Y */ 4, /* Z */ 2, /* [ */
  3, /* \ */ 2, /* ] */ 3, /* ^ */ 4, /* _ */
  2, /* ` */ 4, /* a */ 4, /* b */ 4, /* c */
  4, /* d */ 4, /* e */ 3, /* f */ 4, /* g */
  4, /* h */ 1, /* i */ 3, /* j */ 4, /* k */
  2, /* l */ 5, /* m */ 4, /* n */ 4, /* o */
  4, /* p */ 4, /* q */ 3, /* r */ 4, /* s */
  3, /* t */ 4, /* u */ 5, /* v */ 5, /* w */
  5, /* x */ 4, /* y */ 4, /* z */ 3, /* { */
  1, /* | */ 3, /* } */
};

unsigned char font[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* */
  0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x40, /* ! */
  0x00, 0x50, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, /* " */
  0x00, 0x28, 0x7c, 0x28, 0x28, 0x7c, 0x28, 0x28, /* # */
  0x00, 0x10, 0x3c, 0x50, 0x38, 0x14, 0x78, 0x10, /* $ */
  0x00, 0x20, 0x54, 0x28, 0x10, 0x28, 0x54, 0x08, /* % */
  0x00, 0x20, 0x50, 0x50, 0x20, 0x54, 0x48, 0x34, /* & */
  0x00, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, /* ' */
  0x00, 0x20, 0x40, 0x40, 0x40, 0x40, 0x40, 0x20, /* ( */
  0x00, 0x40, 0x20, 0x20, 0x20, 0x20, 0x20, 0x40, /* ) */
  0x00, 0x10, 0x54, 0x38, 0x10, 0x38, 0x54, 0x10, /* * */
  0x00, 0x00, 0x10, 0x10, 0x7c, 0x10, 0x10, 0x00, /* + */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x40, /* , */
  0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00, /* - */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, /* . */
  0x00, 0x10, 0x10, 0x20, 0x20, 0x20, 0x40, 0x40, /* / */
  0x00, 0x30, 0x48, 0x58, 0x68, 0x48, 0x48, 0x30, /* 0 */
  0x00, 0x60, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, /* 1 */
  0x00, 0x70, 0x08, 0x08, 0x30, 0x40, 0x40, 0x78, /* 2 */
  0x00, 0x70, 0x08, 0x08, 0x30, 0x08, 0x08, 0x70, /* 3 */
  0x00, 0x48, 0x48, 0x48, 0x48, 0x38, 0x08, 0x08, /* 4 */
  0x00, 0x78, 0x40, 0x40, 0x70, 0x08, 0x08, 0x70, /* 5 */
  0x00, 0x30, 0x40, 0x40, 0x70, 0x48, 0x48, 0x30, /* 6 */
  0x00, 0x78, 0x08, 0x08, 0x10, 0x20, 0x20, 0x20, /* 7 */
  0x00, 0x30, 0x48, 0x48, 0x30, 0x48, 0x48, 0x30, /* 8 */
  0x00, 0x30, 0x48, 0x48, 0x38, 0x08, 0x08, 0x30, /* 9 */
  0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x40, 0x00, /* : */
  0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x40, 0x80, /* ; */
  0x00, 0x00, 0x10, 0x20, 0x40, 0x20, 0x10, 0x00, /* < */
  0x00, 0x00, 0x00, 0x7c, 0x00, 0x7c, 0x00, 0x00, /* = */
  0x00, 0x00, 0x40, 0x20, 0x10, 0x20, 0x40, 0x00, /* > */
  0x00, 0x70, 0x08, 0x10, 0x20, 0x20, 0x00, 0x20, /* ? */
  0x00, 0x18, 0x24, 0x4c, 0x54, 0x48, 0x22, 0x1c, /* @ */
  0x00, 0x30, 0x48, 0x48, 0x78, 0x48, 0x48, 0x48, /* A */
  0x00, 0x70, 0x48, 0x48, 0x70, 0x48, 0x48, 0x70, /* B */
  0x00, 0x38, 0x40, 0x40, 0x40, 0x40, 0x40, 0x38, /* C */
  0x00, 0x70, 0x48, 0x48, 0x48, 0x48, 0x48, 0x70, /* D */
  0x00, 0x70, 0x40, 0x40, 0x70, 0x40, 0x40, 0x70, /* E */
  0x00, 0x70, 0x40, 0x40, 0x70, 0x40, 0x40, 0x40, /* F */
  0x00, 0x38, 0x40, 0x40, 0x58, 0x48, 0x48, 0x30, /* G */
  0x00, 0x48, 0x48, 0x48, 0x78, 0x48, 0x48, 0x48, /* H */
  0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, /* I */
  0x00, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x60, /* J */
  0x00, 0x48, 0x50, 0x50, 0x60, 0x50, 0x50, 0x48, /* K */
  0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x70, /* L */
  0x00, 0x44, 0x6c, 0x6c, 0x54, 0x54, 0x44, 0x44, /* M */
  0x00, 0x48, 0x68, 0x68, 0x58, 0x58, 0x48, 0x48, /* N */
  0x00, 0x30, 0x48, 0x48, 0x48, 0x48, 0x48, 0x30, /* O */
  0x00, 0x70, 0x48, 0x48, 0x70, 0x40, 0x40, 0x40, /* P */
  0x00, 0x30, 0x48, 0x48, 0x48, 0x48, 0x50, 0x28, /* Q */
  0x00, 0x70, 0x48, 0x48, 0x70, 0x50, 0x48, 0x48, /* R */
  0x00, 0x38, 0x40, 0x40, 0x30, 0x08, 0x08, 0x70, /* S */
  0x00, 0x7c, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, /* T */
  0x00, 0x48, 0x48, 0x48, 0x48, 0x48, 0x48, 0x30, /* U */
  0x00, 0x44, 0x44, 0x28, 0x28, 0x28, 0x10, 0x10, /* V */
  0x00, 0x44, 0x54, 0x54, 0x54, 0x28, 0x28, 0x28, /* W */
  0x00, 0x44, 0x28, 0x28, 0x10, 0x28, 0x28, 0x44, /* X */
  0x00, 0x44, 0x28, 0x28, 0x10, 0x10, 0x10, 0x10, /* Y */
  0x00, 0x78, 0x08, 0x10, 0x30, 0x20, 0x40, 0x78, /* Z */
  0x00, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x60, /* [ */
  0x00, 0x40, 0x40, 0x20, 0x20, 0x20, 0x10, 0x10, /* \ */
  0x00, 0x60, 0x20, 0x20, 0x20, 0x20, 0x20, 0x60, /* [ */
  0x00, 0x20, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, /* ^ */
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, /* _ */
  0x00, 0x40, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, /* ` */
  0x00, 0x00, 0x00, 0x70, 0x08, 0x38, 0x48, 0x38, /* a */
  0x00, 0x40, 0x40, 0x70, 0x48, 0x48, 0x48, 0x70, /* b */
  0x00, 0x00, 0x00, 0x38, 0x40, 0x40, 0x40, 0x38, /* c */
  0x00, 0x08, 0x08, 0x38, 0x48, 0x48, 0x48, 0x38, /* d */
  0x00, 0x00, 0x00, 0x30, 0x48, 0x78, 0x40, 0x38, /* e */
  0x00, 0x10, 0x20, 0x70, 0x20, 0x20, 0x20, 0x20, /* f */
  0x00, 0x00, 0x00, 0x38, 0x48, 0x38, 0x08, 0x70, /* g */
  0x00, 0x40, 0x40, 0x70, 0x48, 0x48, 0x48, 0x48, /* h */
  0x00, 0x40, 0x00, 0x40, 0x40, 0x40, 0x40, 0x40, /* i */
  0x00, 0x10, 0x00, 0x10, 0x10, 0x10, 0x10, 0x60, /* j */
  0x00, 0x40, 0x40, 0x48, 0x50, 0x60, 0x50, 0x48, /* k */
  0x00, 0x60, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, /* l */
  0x00, 0x00, 0x00, 0x78, 0x54, 0x54, 0x54, 0x54, /* m */
  0x00, 0x00, 0x00, 0x70, 0x48, 0x48, 0x48, 0x48, /* n */
  0x00, 0x00, 0x00, 0x30, 0x48, 0x48, 0x48, 0x30, /* o */
  0x00, 0x00, 0x00, 0x70, 0x48, 0x48, 0x70, 0x40, /* p */
  0x00, 0x00, 0x00, 0x38, 0x48, 0x48, 0x38, 0x08, /* q */
  0x00, 0x00, 0x00, 0x50, 0x60, 0x40, 0x40, 0x40, /* r */
  0x00, 0x00, 0x00, 0x38, 0x40, 0x30, 0x08, 0x70, /* s */
  0x00, 0x00, 0x20, 0x70, 0x20, 0x20, 0x20, 0x20, /* t */
  0x00, 0x00, 0x00, 0x48, 0x48, 0x48, 0x48, 0x38, /* u */
  0x00, 0x00, 0x00, 0x44, 0x44, 0x28, 0x28, 0x10, /* v */
  0x00, 0x00, 0x00, 0x44, 0x54, 0x54, 0x28, 0x28, /* w */
  0x00, 0x00, 0x00, 0x44, 0x28, 0x10, 0x28, 0x44, /* x */
  0x00, 0x00, 0x00, 0x48, 0x48, 0x38, 0x08, 0x70, /* y */
  0x00, 0x00, 0x00, 0x78, 0x08, 0x30, 0x40, 0x78, /* z */
  0x00, 0x10, 0x20, 0x20, 0x40, 0x20, 0x20, 0x10, /* { */
  0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, /* | */
  0x00, 0x40, 0x20, 0x20, 0x10, 0x20, 0x20, 0x40, /* } */
  0x00, 0x00, 0x00, 0x39, 0x46, 0x00, 0x00, 0x00, /* ~ */

  0x00, 0x10, 0x7e, 0x10, 0x3e, 0x55, 0x59, 0x32, /* a */
  0x00, 0x00, 0x42, 0x42, 0x41, 0x41, 0x51, 0x20, /* i */
  0x00, 0x3c, 0x00, 0x7c, 0x02, 0x02, 0x04, 0x38, /* u */
  0x00, 0x3c, 0x00, 0x7e, 0x04, 0x18, 0x28, 0x47, /* e */
  0x00, 0x12, 0x7d, 0x10, 0x3e, 0x51, 0x51, 0x36, /* o */
  0x00, 0x22, 0x79, 0x25, 0x24, 0x24, 0x44, 0x58, /* ka */
  0x00, 0x3e, 0x08, 0x7f, 0x04, 0x3a, 0x40, 0x3c, /* ki */
  0x00, 0x04, 0x08, 0x30, 0x40, 0x30, 0x08, 0x04, /* ku */
  0x00, 0x42, 0x5f, 0x42, 0x42, 0x42, 0x42, 0x4c, /* ke */
  0x00, 0x3c, 0x00, 0x00, 0x00, 0x40, 0x40, 0x3e, /* ko */
  0x00, 0x08, 0x7f, 0x04, 0x3c, 0x42, 0x40, 0x3c, /* sa */
  0x00, 0x40, 0x40, 0x40, 0x42, 0x42, 0x44, 0x38, /* shi */
  0x00, 0x04, 0x7f, 0x0c, 0x14, 0x14, 0x0c, 0x18, /* su */
  0x00, 0x24, 0x7f, 0x24, 0x24, 0x2c, 0x20, 0x1e, /* se */
  0x00, 0x3c, 0x08, 0x10, 0x7e, 0x10, 0x20, 0x1c, /* so */
  0x00, 0x20, 0x7e, 0x20, 0x2e, 0x40, 0x50, 0x4e, /* ta */
  0x00, 0x10, 0x7e, 0x10, 0x1e, 0x21, 0x01, 0x1e, /* chi */
  0x00, 0x00, 0x1c, 0x62, 0x01, 0x01, 0x02, 0x1c, /* tsu */
  0x00, 0x7f, 0x04, 0x08, 0x10, 0x10, 0x10, 0x0e, /* te */
  0x00, 0x20, 0x26, 0x18, 0x20, 0x40, 0x40, 0x3e, /* to */
  0x00, 0x22, 0x79, 0x22, 0x22, 0x4e, 0x53, 0x0c, /* na */
  0x00, 0x00, 0x4f, 0x40, 0x40, 0x48, 0x48, 0x47, /* ni */
  0x00, 0x24, 0x3e, 0x65, 0x59, 0x4b, 0x55, 0x26, /* nu */
  0x00, 0x20, 0x2e, 0x71, 0x21, 0x67, 0x29, 0x26, /* ne */
  0x00, 0x1c, 0x2a, 0x49, 0x49, 0x49, 0x51, 0x26, /* no */
  0x00, 0x42, 0x5f, 0x42, 0x42, 0x4e, 0x53, 0x4c, /* ha */
  0x00, 0x74, 0x24, 0x43, 0x42, 0x42, 0x44, 0x38, /* hi */
  0x00, 0x3c, 0x08, 0x10, 0x4a, 0x45, 0x45, 0x18, /* fu */
  0x00, 0x00, 0x10, 0x28, 0x44, 0x44, 0x02, 0x01, /* he */
  0x00, 0x5f, 0x42, 0x5f, 0x42, 0x4e, 0x53, 0x4c, /* ho */
  0x00, 0x7e, 0x08, 0x7e, 0x08, 0x3c, 0x4a, 0x38, /* ma */
  0x00, 0x38, 0x0a, 0x3a, 0x56, 0x53, 0x64, 0x08, /* mi */
  0x00, 0x10, 0x7a, 0x11, 0x30, 0x51, 0x51, 0x3e, /* mu */
  0x00, 0x24, 0x3e, 0x25, 0x55, 0x55, 0x59, 0x32, /* me */
  0x00, 0x20, 0x78, 0x20, 0x7a, 0x22, 0x22, 0x1c, /* mo */
  0x00, 0x48, 0x2e, 0x71, 0x21, 0x26, 0x10, 0x10, /* ya */
  0x00, 0x08, 0x5e, 0x69, 0x49, 0x59, 0x4e, 0x10, /* yu */
  0x00, 0x08, 0x0e, 0x08, 0x08, 0x3c, 0x4a, 0x38, /* yo */
  0x00, 0x1c, 0x40, 0x5e, 0x61, 0x41, 0x01, 0x1e, /* ra */
  0x00, 0x4c, 0x52, 0x62, 0x42, 0x42, 0x04, 0x18, /* ri */
  0x00, 0x3e, 0x08, 0x3e, 0x41, 0x19, 0x25, 0x1e, /* ru */
  0x00, 0x2c, 0x72, 0x22, 0x22, 0x62, 0x23, 0x22, /* re */
  0x00, 0x3e, 0x08, 0x1e, 0x21, 0x41, 0x01, 0x1e, /* ro */
  0x00, 0x20, 0x2e, 0x71, 0x21, 0x61, 0x21, 0x26, /* wa */
  0x00, 0x08, 0x7f, 0x14, 0x2f, 0x4a, 0x10, 0x0f, /* wo */
  0x00, 0x10, 0x10, 0x20, 0x31, 0x29, 0x49, 0x46, /* n */
};

int abs (int j)
{
  if (j == 0) return 0;
  if (j > 0) return j;
  return -j;
}

static void
clear_screen (unsigned int color)
{
  int i;
  for (i = 0; i < WIDTH * HEIGHT; i++)
    pixels[i] = color;
}

static void
draw_pixel (int x, int y, unsigned int color)
{
  if (x < WIDTH && y < HEIGHT && x > 0 && y > 0)
    pixels[y * WIDTH + x] = color;
}

static void
draw_icn (int x, int y, unsigned char *sprite, unsigned int color)
{
  int y2 = y + 8, h;

  for (; y < y2; y++, sprite++) {
    for (h = 0; h < 8; h++) {
      if (*sprite << h & 0x80)
        draw_pixel (x + h, y, color);
    }
  }
}

void
draw_letter (int x, int y, int letter, unsigned int color)
{
  int idx = letter - 32;

  draw_icn (x, y, font + (idx * 8), color);
}

void
draw_string (int x, int y, char *string, unsigned int color)
{
  int i, c;

  c = 0;

  for (i = 0; i < (int)strlen (string); i++) {
    int glyph_width = width[string[i] - 32];
    draw_letter (x + c, y, string[i], color);
    c += glyph_width + 2;
  }
}

static void
set_window_size (SDL_Window *window, int w, int h)
{
  SDL_Point win_old;

  SDL_GetWindowSize (window, &win_old.x, &win_old.y);

  if (w == win_old.x && h == win_old.y) return;

  SDL_RenderClear (gRenderer);
  SDL_SetWindowSize (window, w, h);
}

static void
set_zoom (int z, int win)
{
  if (z < 1) return;

  if (win)
    set_window_size (gWindow, WIDTH * z, HEIGHT * z);

  zoom = z;
}

static void
emu_end (void)
{
    free (pixels);

    SDL_DestroyTexture (gTexture), gTexture = NULL;
    SDL_DestroyRenderer (gRenderer), gRenderer = NULL;
    SDL_DestroyWindow (gWindow), gWindow = NULL;

    SDL_Quit ();

    exit(0);
}

static int
init (void)
{
    if(SDL_Init(SDL_INIT_VIDEO) < 0)
      fprintf (stderr, "INIT ERROR: %s\n", SDL_GetError ());

    gWindow = SDL_CreateWindow (TITLE,
                                SDL_WINDOWPOS_UNDEFINED,
                                SDL_WINDOWPOS_UNDEFINED,
                                WIDTH, HEIGHT,
                                SDL_WINDOW_SHOWN);
    if (gWindow == NULL)
      fprintf (stderr, "WINDOW ERROR: %s\n", SDL_GetError ());

    gRenderer = SDL_CreateRenderer (gWindow, -1, 0);
    if (gRenderer == NULL)
      fprintf (stderr, "RENDERER ERROR: %s\n", SDL_GetError ());

    gTexture = SDL_CreateTexture(gRenderer,
                                 SDL_PIXELFORMAT_ARGB8888,
                                 SDL_TEXTUREACCESS_STATIC,
                                 WIDTH, HEIGHT);
    if (gTexture == NULL)
      fprintf (stderr, "TEXTURE ERROR: %s\n", SDL_GetError ());

    pixels = (unsigned int *)malloc (WIDTH * HEIGHT * sizeof (unsigned int));
    if (pixels == NULL)
      fprintf (stderr, "PIXELS ERROR: %s\n", "Failed to allocate memory");

    SDL_ShowCursor (1);

    return 1;
}

int
string_pixel_length (char *string)
{
  int i;
  int label_width = 0;

  for (i = 0; i < strlen (string); i++) {
    label_width += width[string[i] - 32] + 2;
  }

  return label_width;
}

static void
draw_string_left_aligned (int x, int y, char *string, unsigned int color)
{
  draw_string (WIDTH - string_pixel_length (string) - x, y, string, color);
}

void
draw ()
{
  clear_screen (WHITE);

  draw_string (4, 4, "A small collection of", BLACK);
  draw_string (4, 14, "small applications for", BLACK);
  draw_string (4, 24, "your desktop.", BLACK);

  draw_string_left_aligned (4, HEIGHT - 22, "Enjoy!", BLACK);
  draw_string_left_aligned (4, HEIGHT - 12, "Made by fkinos", BLACK);
}

int
main (int argc, char *argv[])
{
  Uint32 begintime = 0, endtime = 0, delta = 0;

  if (!init ())
    fprintf (stderr, "INIT ERROR: FAILURE\n");
  set_zoom (1, 1);

  clear_screen (BLACK);

  /* Game Loop */
  while (1) {
    SDL_Event e;

    /* don't draw if not needed */
    if (!begintime) {
      begintime = SDL_GetTicks ();
    } else {
      delta = endtime - begintime;
    }

    if (delta < 30)
      SDL_Delay (30 - delta);

    /* gather events from the user and the operation system */
    while (SDL_PollEvent (&e) != 0) {
      switch(e.type) {
      case SDL_QUIT: emu_end (); break;
      case SDL_WINDOWEVENT: reqdraw = 1; break;
      }
    }

    /* draw */
    draw ();

    /* draw pixels array to SDL texture */
    SDL_UpdateTexture (gTexture, NULL, pixels, WIDTH * sizeof (unsigned int));
    SDL_RenderCopy (gRenderer, gTexture, NULL, NULL);
    SDL_RenderPresent (gRenderer);

    begintime = endtime;
    endtime = SDL_GetTicks ();
  }

  emu_end();

  return 0;
}
